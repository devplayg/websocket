{{template "base.html" .}}

{{define "contents"}}

<form id="form-chat">
    <div class="row">
        <div class="col-xs-3">
            <input type="text" class="form-control" name="username" value="won" placeholder="Username" />
            <div class="mt5">
                <button type="button" class="btn btn-primary btn-connect">Connect</button>
                <button type="button" class="btn btn-danger btn-disconnect">Disconnect</button>
            </div>
        </div>
        <div class="col-xs-9">
            <div class="panel panel-default">
                <div class="panel-body">
                    <div id="chat" style="height:300px; overflow-y: scroll;"></div>

                    <div class="row mt5">
                        <div class="col-xs-10">
                            <input type="text" name="message" class="form-control chat" disabled />
                        </div>
                        <div class="col-xs-2">
                            <button type="submit" class="btn btn-primary btn-block btn-send chat" disabled>Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{{end}}



{{ define "js" }}
<script>
$(function() {
var socket = null;

$(".btn-connect").click(function(e) {
    if (socket) {
        socket.close();
    }
    var username = $.trim( $( "#form-chat input[name=username]" ).val() );
    if ( username.length < 1 ) {
        return;
    }

    // Connect to server
    socket = new WebSocket("ws://" + document.location.host + "/ws?username=" + username);
    if ( socket ) {
        socket.onclose = function( e ) {
            //send( e. );
            //$("#chat").append("C").append("<br/>");
        };
        socket.onmessage = function( e ) {
            //console.log(e.data);
            var event = JSON.parse( e.data );
            console.log(event);
            //var messages = e.data.split('\n');
//            for (var i = 0; i < messages.length; i++) {
                var $p = $( "<p/>" ).text( event.Message );
                $("#chat").append($p);
                //console.log(event.Message);
                //$("#chat").append(messages[i]).append("<br/>");
            //}
        };
        $(".chat").prop("disabled", false);
        $( "#form-chat input[name=message]" ).focus();
    } else {
        $(".chat").prop("disabled", true);
    }

});

$("#form-chat").submit(function(e) {
    e.preventDefault();
    send( $( "#form-chat input[name=message]" ).val() );
});

$(".btn-disconnect").click(function(e) {
    if (!socket) {
        return false;
    }
    socket.close();
});

var send = function( message ) {
    var event = {
        message: message
    }
    socket.send( JSON.stringify( event ) );
    $( "#form-chat input[name=message]" ).val("");
}





});

</script>
{{end}}


